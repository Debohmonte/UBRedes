<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestión de Facturas</title>
    <style>
        /* Your existing styles */
        .pdf-button {
            background-color: lightblue;
            padding: 5px 10px;
            border: none;
            cursor: pointer;
        }
    </style>
</head>
<body>

    <div class="container">
        <header>
            <h1 style="margin-right: auto;">Facturas</h1>
            <label for="orden">Orden:</label>
            <input type="text" id="orden" name="orden" value="fecha" readonly>
            <input type="hidden" id="orden_direccion" value="asc">
            <button id="btCargarDatos">Cargar datos</button>
            <button id="btVaciarDatos">Vaciar datos</button>
            <button id="btLimpiarFiltros">Limpiar filtros</button>
            <button id="btAltaRegistro">Alta registro</button>
        </header>

        <table id="data-table">
            <thead>
                <tr>
                    <th data-column="nro_factura">Número Factura</th>
                    <th data-column="cuil_emisor">CUIL Emisor</th>
                    <th data-column="cuil_receptor">CUIL Receptor</th>
                    <th data-column="monto">Monto</th>
                    <th data-column="iva">IVA</th>
                    <th data-column="total">Total</th>
                    <th data-column="descripcion">Descripción</th>
                    <th data-column="fecha">Fecha</th>
                    <th>PDF</th> <!-- Added PDF column -->
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>

    <footer></footer>

    <!-- Your modal and other code for Alta form -->

    <script>
        // Function to apply filters based on the user's input
        function applyFilters(data) {
            const filters = {
                nro_factura: document.getElementById('filter_nro_factura').value.toLowerCase(),
                cuil_emisor: document.getElementById('filter_cuil_emisor').value.toLowerCase(),
                cuil_receptor: document.getElementById('filter_cuil_receptor').value.toLowerCase(),
                monto: document.getElementById('filter_monto').value.toLowerCase(),
                iva: document.getElementById('filter_iva').value,
                total: document.getElementById('filter_total').value.toLowerCase(),
                descripcion: document.getElementById('filter_descripcion').value.toLowerCase(),
                fecha: document.getElementById('filter_fecha').value
            };

            const filteredData = data.filter(item => {
                return (
                    (!filters.nro_factura || item.nro_factura.toLowerCase().includes(filters.nro_factura)) &&
                    (!filters.cuil_emisor || item.cuil_emisor.toLowerCase().includes(filters.cuil_emisor)) &&
                    (!filters.cuil_receptor || item.cuil_receptor.toLowerCase().includes(filters.cuil_receptor)) &&
                    (!filters.monto || item.monto.includes(filters.monto)) &&
                    (!filters.iva || item.iva == filters.iva) &&
                    (!filters.total || item.total.includes(filters.total)) &&
                    (!filters.descripcion || item.descripcion.toLowerCase().includes(filters.descripcion)) &&
                    (!filters.fecha || item.fecha == filters.fecha)
                );
            });

            return filteredData;
        }

        // Cargar datos
        document.getElementById('btCargarDatos').addEventListener('click', function() {
            const orden = document.getElementById('orden').value;
            const ordenDireccion = document.getElementById('orden_direccion').value;

            fetch(`cargar_datos.php?orden=${orden}&direccion=${ordenDireccion}`, { method: 'GET' })
            .then(response => response.json())
            .then(data => {
                const filteredData = applyFilters(data);
                const tableBody = document.querySelector('#data-table tbody');
                tableBody.innerHTML = '';
                filteredData.forEach(item => {
                    const row = `<tr>
                                    <td>${item.nro_factura}</td>
                                    <td>${item.cuil_emisor}</td>
                                    <td>${item.cuil_receptor}</td>
                                    <td>${item.monto}</td>
                                    <td>${item.iva}</td>
                                    <td>${item.total}</td>
                                    <td>${item.descripcion}</td>
                                    <td>${item.fecha}</td>
                                    <td>
                                        <a href="${item.pdf_path}" target="_blank">
                                            <button class="pdf-button">Ver PDF</button>
                                        </a>
                                    </td>
                                </tr>`;
                    tableBody.innerHTML += row;
                });
            })
            .catch(error => {
                console.error('Error fetching data:', error);
            });
        });

        // Add event listeners for sorting and filtering
        document.querySelectorAll('thead th').forEach(th => {
            th.addEventListener('click', function() {
                const column = th.getAttribute('data-column');
                const currentOrder = document.getElementById('orden').value;
                const currentDirection = document.getElementById('orden_direccion').value;

                if (currentOrder === column) {
                    document.getElementById('orden_direccion').value = currentDirection === 'asc' ? 'desc' : 'asc';
                } else {
                    document.getElementById('orden').value = column;
                    document.getElementById('orden_direccion').value = 'asc';
                }

                document.getElementById('btCargarDatos').click();
            });
        });

        const filterInputs = document.querySelectorAll('thead input, thead select');
        filterInputs.forEach(input => {
            input.addEventListener('input', function() {
                document.getElementById('btCargarDatos').click();
            });
        });

        document.getElementById('btVaciarDatos').addEventListener('click', function() {
            document.querySelector('#data-table tbody').innerHTML = '';
        });

        document.getElementById('btLimpiarFiltros').addEventListener('click', function() {
            document.querySelectorAll('thead input, thead select').forEach(input => input.value = '');
        });
    </script>
</body>
</html>
