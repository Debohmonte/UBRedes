<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestión de Facturas</title>
    <style>
        body { font-family: Arial, sans-serif; background-color: #f4f4f4; }
        h1 { font-size: 24px; font-weight: bold; }
        header { display: flex; align-items: center; background-color: beige; padding: 20px; }
        label { font-size: 18px; font-weight: bold; margin-right: 10px; }
        input, button { height: 30px; font-size: 14px; margin-right: 10px; }
        button { background-color: lightgray; border: 1px solid black; height: 50px; width: 150px; cursor: pointer; }
        button:hover { background-color: #ddd; }
        .container { background-color: beige; padding: 10px; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        table, th, td { border: 1px solid #ddd; }
        th, td { padding: 12px; text-align: center; cursor: pointer; }
        footer { background-color: #FF7361; height: 30px; margin-top: 10px; }
        .modal { display: none; position: fixed; z-index: 1; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.4); }
        .modal-content { background-color: #fff; margin: 10% auto; padding: 20px; border: 1px solid #888; width: 50%; border-radius: 8px; }
        .close { color: #aaa; float: right; font-size: 28px; font-weight: bold; cursor: pointer; }
        .close:hover { color: black; }
        input[type="text"], input[type="number"], input[type="date"], select {
            width: 100%;
            padding: 5px;
            margin: 5px 0;
        }
    </style>
</head>
<body>

    <div class="container">
        <header>
            <h1 style="margin-right: auto;">Facturas</h1>
            <label for="orden">Orden:</label>
            <input type="text" id="orden" name="orden" value="fecha" readonly>
            <input type="hidden" id="orden_direccion" value="asc"> <!-- Keeps track of sorting direction -->
            <button id="btCargarDatos">Cargar datos</button>
            <button id="btVaciarDatos">Vaciar datos</button>
            <button id="btLimpiarFiltros">Limpiar filtros</button>
            <button id="btAltaRegistro">Alta registro</button>
        </header>

        <table id="data-table">
            <thead>
                <tr>
                    <th data-column="nro_factura">Número Factura</th>
                    <th data-column="cuil_emisor">CUIL Emisor</th>
                    <th data-column="cuil_receptor">CUIL Receptor</th>
                    <th data-column="monto">Monto</th>
                    <th data-column="iva">IVA</th>
                    <th data-column="total">Total</th>
                    <th data-column="descripcion">Descripción</th>
                    <th data-column="fecha">Fecha</th>
                </tr>
                <!-- Row for filters -->
                <tr>
                    <td><input type="text" id="filter_nro_factura" placeholder="Número de Factura"></td>
                    <td><input type="text" id="filter_cuil_emisor" placeholder="Emisor"></td>
                    <td><input type="text" id="filter_cuil_receptor" placeholder="Receptor"></td>
                    <td><input type="number" id="filter_monto" placeholder="Monto"></td>
                    <td>
                        <select id="filter_iva">
                            <option value="">IVA</option>
                            <option value="10.50">10.50</option>
                            <option value="21.00">21.00</option>
                        </select>
                    </td>
                    <td><input type="number" id="filter_total" placeholder="Total"></td>
                    <td><input type="text" id="filter_descripcion" placeholder="Descripción"></td>
                    <td><input type="date" id="filter_fecha" placeholder="Fecha"></td>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>

    <footer></footer>

    <!-- Alta Modal -->
    <div id="altaModal" class="modal">
        <div class="modal-content">
            <span class="close" id="closeAltaModal">&times;</span>
            <h2>Crear Nueva Factura</h2>
            <form id="formAlta" method="POST" action="alta_factura.php">
                <label for="nro_factura">Número Factura</label>
                <input type="text" id="nro_factura" name="nro_factura" required>

                <label for="cuil_emisor">CUIL Emisor</label>
                <input type="text" id="cuil_emisor" name="cuil_emisor" required>

                <label for="cuil_receptor">CUIL Receptor</label>
                <input type="text" id="cuil_receptor" name="cuil_receptor" required>

                <label for="monto">Monto</label>
                <input type="number" id="monto" name="monto" required min="0" step="0.01">

                <label for="iva">IVA</label>
                <input type="number" id="iva" name="iva" required min="0" step="0.01">

                <label for="total">Total</label>
                <input type="number" id="total" name="total" required min="0" step="0.01">

                <label for="descripcion">Descripción de Factura</label>
                <input type="text" id="descripcion" name="descripcion" required>

                <label for="fecha">Fecha</label>
                <input type="date" id="fecha" name="fecha" required>

                <button type="submit">Guardar Factura</button>
            </form>
        </div>
    </div>

    <script>
        var altaModal = document.getElementById("altaModal");
        var openAltaModalBtn = document.getElementById("btAltaRegistro");
        var closeAltaModalBtn = document.getElementById("closeAltaModal");

        openAltaModalBtn.onclick = function() {
            altaModal.style.display = "block";
        }
        closeAltaModalBtn.onclick = function() {
            altaModal.style.display = "none";
        }
        window.onclick = function(event) {
            if (event.target == altaModal) {
                altaModal.style.display = "none";
            }
        }

        // Function to apply filters based on the user's input
        function applyFilters(data) {
            const filters = {
                nro_factura: document.getElementById('filter_nro_factura').value.toLowerCase(),
                cuil_emisor: document.getElementById('filter_cuil_emisor').value.toLowerCase(),
                cuil_receptor: document.getElementById('filter_cuil_receptor').value.toLowerCase(),
                monto: document.getElementById('filter_monto').value.toLowerCase(),
                iva: document.getElementById('filter_iva').value,
                total: document.getElementById('filter_total').value.toLowerCase(),
                descripcion: document.getElementById('filter_descripcion').value.toLowerCase(),
                fecha: document.getElementById('filter_fecha').value
            };

            const filteredData = data.filter(item => {
                return (
                    (!filters.nro_factura || item.nro_factura.toLowerCase().includes(filters.nro_factura)) &&
                    (!filters.cuil_emisor || item.cuil_emisor.toLowerCase().includes(filters.cuil_emisor)) &&
                    (!filters.cuil_receptor || item.cuil_receptor.toLowerCase().includes(filters.cuil_receptor)) &&
                    (!filters.monto || item.monto.includes(filters.monto)) &&
                    (!filters.iva || item.iva == filters.iva) &&
                    (!filters.total || item.total.includes(filters.total)) &&
                    (!filters.descripcion || item.descripcion.toLowerCase().includes(filters.descripcion)) &&
                    (!filters.fecha || item.fecha == filters.fecha)
                );
            });

            return filteredData;
        }

        // Cargar datos
        document.getElementById('btCargarDatos').addEventListener('click', function() {
            const orden = document.getElementById('orden').value;  // Get the current order
            const ordenDireccion = document.getElementById('orden_direccion').value;  // Get current sorting direction

            fetch(`cargar_datos.php?orden=${orden}&direccion=${ordenDireccion}`, { method: 'GET' })
            .then(response => response.json())
            .then(data => {
                const filteredData = applyFilters(data);  // Apply filters
                const tableBody = document.querySelector('#data-table tbody');
                tableBody.innerHTML = '';  // Clear previous data
                filteredData.forEach(item => {
                    const row = `<tr>
                                    <td>${item.nro_factura}</td>
                                    <td>${item.cuil_emisor}</td>
                                    <td>${item.cuil_receptor}</td>
                                    <td>${item.monto}</td>
                                    <td>${item.iva}</td>
                                    <td>${item.total}</td>
                                    <td>${item.descripcion}</td>
                                    <td>${item.fecha}</td>
                                </tr>`;
                    tableBody.innerHTML += row;
                });
            })
            .catch(error => {
                console.error('Error fetching data:', error);
            });
        });

        // Add event listeners to table headers for ordering
        document.querySelectorAll('thead th').forEach(th => {
            th.addEventListener('click', function() {
                const column = th.getAttribute('data-column');
                const currentOrder = document.getElementById('orden').value;
                const currentDirection = document.getElementById('orden_direccion').value;

                // Toggle the sorting direction based on current settings
                if (currentOrder === column) {
                    document.getElementById('orden_direccion').value = currentDirection === 'asc' ? 'desc' : 'asc';
                } else {
                    document.getElementById('orden').value = column;
                    document.getElementById('orden_direccion').value = 'asc';  // Default to ascending
                }

                document.getElementById('btCargarDatos').click();  // Reload data with new order
            });
        });

        // Event listeners for filter input fields
        const filterInputs = document.querySelectorAll('thead input, thead select');
        filterInputs.forEach(input => {
            input.addEventListener('input', function() {
                document.getElementById('btCargarDatos').click();  // Reapply filters on data
            });
        });

        // Vaciar datos
        document.getElementById('btVaciarDatos').addEventListener('click', function() {
            document.querySelector('#data-table tbody').innerHTML = ''; // Clear table data
        });

        // Limpiar filtros
        document.getElementById('btLimpiarFiltros').addEventListener('click', function() {
            document.querySelectorAll('thead input, thead select').forEach(input => input.value = '');  // Reset all filters
        });
    </script>
</body>
</html>
